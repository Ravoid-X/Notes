## 概述
1. 从宏观上看，可以分为一个核心架构和五大核心子系统，并通过系统调用这一桥梁与用户空间进行交互。
2. 内核采用的是 宏内核 架构，意味着整个内核，包括进程调度、内存管理、文件系统和设备驱动等所有核心功能，都运行在一个单一的、巨大的内核地址空间中。
3. 优点是组件之间可以直接通信，效率较高；缺点时可维护性和可扩展性较差。
4. 引入内核模块机制，使内核在运行时可以动态地加载或卸去代码模块（例如设备驱动、文件系统），从而实现了高度的模块化。兼顾了性能与灵活性。
## 空间
1. 用户空间（Ring 3）：应用程序运行的地方，访问硬件资源受到限制。
2. 内核空间（Ring 0）：内核代码运行的地方，拥有直接访问硬件的最高权限。
3. 两者之间通过系统调用接口进行通信，这是用户空间程序请求内核服务的唯一合法途径。
## 五大核心子系统
### 进程管理
负责创建、调度、终止和管理系统中的所有进程和线程。
1. 进程与线程：内核将进程视为资源分配的基本单位（拥有独立的内存空间），而线程（称为轻量级进程）则是 CPU 调度的基本单位，它共享所属进程的资源。
2. 进程调度器（Scheduler）：其主要任务是决定哪个进程在哪个 CPU 上运行以及运行多长时间。经过多次演进，目前主要使用的是完全公平调度器（CFS），。
3. 进程间通信（IPC）：内核提供了一系列机制，如管道（Pipe）、信号（Signal）、套接字（Socket）、消息队列（Message Queue）和共享内存（Shared Memory），以支持进程间的同步与数据交换。
### 内存管理
管理子系统负责管理系统的物理内存，并为每个进程提供独立、连续的虚拟地址空间。
1. 虚拟内存：通过将进程的虚拟地址映射到物理地址，实现了进程间的内存隔离，并允许使用比物理内存更大的地址空间。
2. 分页（Paging）：将物理内存和虚拟内存都划分为固定大小的块，称为“页”（通常为 4KB）。通过 页表 来维护虚拟页到物理页的映射关系。
3. 交换与缺页中断：当物理内存不足时，内存管理单元可以将暂时不用的内存页交换到磁盘的交换空间中。当进程需要访问一个已被换出的页时，会触发一个缺页中断，内核会负责将该页从磁盘重新加载到内存中。
4. 内存分配：内核为自身和用户空间程序提供了不同的内存分配机制，如 kmalloc()（分配物理上连续的内存）和 vmalloc()（分配虚拟上连续的内存）用于内核，brk() 和mmap() 系统调用用于用户空间。
### 虚拟文件系统
为用户空间程序提供了统一的文件操作接口，同时能够兼容和管理各种不同类型的具体文件系统。
1. 统一接口：无论是 ext4、XFS、NTFS 还是网络文件系统（NFS），VFS 都通过一组标准的系统调用（如open(), read(), write(), close()）来对外提供服务。应用程序无需关心底层文件系统的具体实现。
2. 核心对象：VFS 主要通过四个核心对象来工作\
（1）超级块：代表一个已挂载的文件系统。\
（2）索引节点（Inode）：代表一个文件，存储了文件的元数据（如权限、大小、创建时间等）。\
（3）目录项（Dentry）：代表一个目录中的一个条目，建立了文件名和 Inode 之间的链接关系，并构成了目录树结构。
3. 文件：代表一个由进程打开的文件，包含了文件的当前读写位置等信息。
### 网络协议栈
负责处理所有与网络相关的操作，实现了标准的TCP/IP协议族。
1. 分层结构：Linux 的网络协议栈也遵循 OSI 模型的思想，自上而下分为\
（1）套接字接口层（Socket Layer）：向用户空间提供 BSD Socket 接口，应用程序通过这些接口进行网络通信。\
（2）传输层：实现 TCP 和 UDP 协议，负责端到端的数据传输。\
（3）网络层：实现 IP 协议，负责数据包的路由和转发。\
（4）链路层：处理与物理网络接口（如以太网卡）的交互，负责帧的发送和接收。
2. 核心数据结构：sk_buff（Socket Buffer）是网络栈中用于在各层之间传递网络数据包的核心数据结构。
#### 设备驱动与管理
内核与硬件设备之间的桥梁，负责初始化硬件、控制硬件工作，并为上层提供统一的接口。
1. 驱动分类：设备驱动通常分为三类：
（1）字符设备：以字节流的方式进行访问，如串口、键盘。
（2）块设备：以固定大小的数据块进行访问，如硬盘、SSD。
（3）网络设备：用于数据包的收发，与网络协议栈紧密集成。
2. 设备文件：“一切皆文件”。内核通过在/dev目录下创建特殊的设备文件，让用户空间程序可以像读写普通文件一样来访问硬件设备。
3. 总线与设备模型：内核通过统一的设备模型来管理系统中的总线（如 PCI, USB, I2C）、控制器和设备，并负责将设备与对应的驱动程序进行匹配。