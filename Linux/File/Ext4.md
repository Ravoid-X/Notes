## 优势
### 存储
1. 文件系统大小：支持高达 1 EB ($1 \text{ Exabyte} = 1024 \text{ PB}$) 的文件系统（而 Ext3 通常限制在 16 TB）。
2. 文件大小：Ext4 支持高达 16 TB 的单个文件（而 Ext3 限制在 2 TB）。
### 区段
最核心的性能改进
1. 一个 Extent 是指一连串连续的物理块，Inode 只需存储起点和长度
2. 对于大文件（尤其是连续写入的），元数据开销极小，文件访问速度更快，并且能显著减少文件碎片。
### 目录索引
1. 默认启用 Htree（一种特殊的 B 树）来索引目录
2. 能以极快的速度定位文件，$O(\log N)$ 时间复杂度
### 向后兼容性
可以将一个 Ext3 文件系统挂载为 Ext4 格式（无需格式化），并逐步启用 Ext4 的新特性。
## 磁盘布局
1. 将磁盘空间划分为一系列的 块组。这种设计旨在将相关的数据和元数据放在一起，以减少磁头寻道时间。
2. 一个典型的块组包含以下部分
### 超级块（Superblock）
1. 存储整个文件系统的全局信息，如总块数、总 Inode 数、块大小、魔术数字等。
2. 主超级块位于块组 0，并在其他块组中有多个备份副本，以便在主副本损坏时进行恢复。
### 块组描述符表（GDT）：
1. 包含所有块组的“元数据”，例如每个块组的位图和 Inode 表在哪里，有多少空闲块等。
2. 和超级块一样，GDT 也有备份副本。
### 数据块位图（Block Bitmap）：
一个比特位（bit）代表一个数据块。1 表示已分配，0 表示空闲。文件系统通过它来快速找到空闲的数据块。
### Inode 位图（Inode Bitmap）：
一个比特位代表一个 Inode。1 表示已分配，0 表示空闲。用于快速找到空闲的 Inode。
### Inode 表（Inode Table）：
该块组所有 Inode 的集合。每个 Inode 都是一个数据结构，用于存储文件的所有元数据（权限、大小、时间戳、所有者等），以及指向文件数据块的 Extent 树。
### 数据块（Data Blocks）：
块组中剩余的大部分空间，用于实际存储文件内容。
## 分配
### 延迟分配
1. 当应用程序写入数据时，Ext4 并不会立即为其分配磁盘块，将数据保存在内存（页缓存）中
2. 直到数据需要被真正刷入磁盘时（例如程序调用 fsync() 或内核的定时器触发），多块分配器才分配物理数据块
3. 分配器已有该文件的更多数据（例如 128MB），可以一次性在磁盘上找到一个足够大的连续空间来写入所有数据。这极大地减少了文件碎片，并提高了写入性能
### 多块分配器（mballoc）
一次性分配多个块。它与延迟分配协同工作，是实现 Extent 的基础
### 持久性预分配
1. 允许应用程序通过 fallocate() 系统调用，为一个文件“预留”物理空间
2. 对于数据库、虚拟机磁盘镜像等应用非常重要。它们可以预先申请一块连续的、有保证的空间，防止将来写入时产生碎片或空间不足。
## 特性
### 日志
1. 使用 JBD2（Journaling Block Device 2）来实现日志功能
2. 默认模式：data=ordered。这是性能和安全性的最佳平衡点\
（1）元数据（如 Inode 变更）会被写入日志。数据块不写入日志，但系统保证数据块会先于元数据被写入磁盘。\
（2）发生崩溃时，日志可以确保文件系统结构（元数据）的一致性。不会遇到“元数据指向了垃圾数据”的情况
3. data = journal（最安全，最慢）：元数据和数据都写入日志（所有数据写两遍）。
4. data = writeback（最快，最不安全）：只记录元数据，不保证数据和元数据的写入顺序。
### 元数据校验和
1. 为超级块、GDT、位图、Inode 等所有元数据结构计算并存储校验和（CRC32c）
2. 读取元数据时，系统会重新计算校验和并进行比对。如果不匹配，说明磁盘上的元数据已损坏。
### 快速 fsck
e2fsck（文件系统检查工具）根据块组描述符表直接跳过未使用的 Inode，加快了文件系统检查的速度
### 弹性块组
1. 允许将多个块组“捆绑”成一个逻辑的“弹性块组”。
2. 将这组中所有块组的元数据（位图、Inode 表）都集中存放在第一个块组中。
3. 释放出的大量连续数据块可用于存储大文件，进一步减少大文件的碎片。
### 在线碎片整理
提供了官方工具 e4defrag，可以在文件系统挂载和使用时对其进行碎片整理
### bigalloc（巨大分配）
1. 在格式化时才能设置的高级特性。将分配的最小单位从“块”（如 4KB）改为“簇”（如 1MB）。
2. 适用场景：专门用于存储超大文件的文件系统（如视频存档库）。
3. 优势：极大减少元数据开销（位图大小缩小 256 倍），提高大文件性能。
4. 劣势：存储小文件会极度浪费空间（一个 1KB 的文件也会占用 1MB）
