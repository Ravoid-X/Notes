## 结构
<img src="../../Pic/Subject/Network/tcpip-structure.jpg" style="width:400px;padding:10px;"/>

## 链路层
处理连接网络的硬件部分。该层既包括操作系统硬件的设备驱动、NIC（网卡）、光纤等物理可见部分，还包括连接器等一切传输媒介。在这一层，数据的传输单位为比特。其主要协议有ARP、RARP等。
### 集线器
1. 多台主机和设备的连接器，把一个端口接收的所有信号向所有端口分发出去。一些集线器在分发之前将弱信号重新生成，一些集线器整理信号的时序以提供所有端口间的同步数据通信。\
<img src="../../Pic/Subject/Network/tcpip-hub.png" style="width:400px;padding:10px;"/>

2. MAC（Media Access Control Address）地址：网络中每台设备都有的唯一的网络标识，长度为 48 位，是由网络设备制造商生产时烧录在网卡的EPROM。\
其中前 24 位（00-16-EA）代表网络硬件制造商的编号，后 24 位（AE-3C-40）是该厂家自己分配的，一般表示系列号。\
A在发送数据包时，在头部添加地址，B 在收到数据包后，根据头部的目标 MAC 地址信息，判断这个数据包的确是发给自己的，于是便收下，否则丢弃\
<img src="../../Pic/Subject/Network/tcpip-mac.png" style="width:400px;padding:10px;"/>

### 交换机
集线器会将消息广播给所有主机，不安全且浪费网络资源，引入交换机，只向目标 MAC 地址指向的那台电脑发送消息\
<img src="../../Pic/Subject/Network/tcpip-switch.png" style="width:400px;padding:10px;"/>

1. 交换机内部维护一张 MAC 地址表，记录着每一个 MAC 地址的设备连接在哪一个端口上。
2. 消息到达交换机时，通过自维护的 MAC 地址表，得到目标机器的 MAC 地址映射的端口号，直接将消息发送到对应端口
3. 通过这样传输方式而组成的小范围的网络，叫做以太网
4. 最开始的时候，MAC 地址表是空的，若 MAC 地址无对应端口，则将数据包发给所有端口，根据响应更新地址表

### 二层交换机
随着机器数量越多，交换机的端口也不够了，此时可将多个交换机连接起来\
<img src="../../Pic/Subject/Network/tcpip-switch-net.png" style="width:400px;padding:10px;"/>

EFGH在左边交换机中为同一个端口号

## 网络层
负责将数据传输到目标地址，目标地址可以是多个网络通过路由器连接而成的某一个地址。另外负责寻找合适的路径到达对方计算机，并把数据帧传送给对方，网络层还可以实现拥塞控制、网际互连等功能。网络层协议的代表包括：ICMP、IP、IGMP等。
### 路由器
电脑的数量发展到成千上万时，交换机已经无法记录如此庞大的映射关系。问题在于连出去的红色网线，后面不知道有多少设备不断连接，使得地址表越来越大。\
红色的网线接入一个新的设备，有自己独立的 MAC 地址，同时能把数据包做一次转发，即为路由器。\
路由器的每一个端口都有独立的 MAC 地址，交换机的 MAC 地址表中，只需要多出一条地址与其端口的映射关系，就可以成功把数据包转交给路由器了。\
<img src="../../Pic/Subject/Network/tcpip-router.png" style="width:400px;padding:10px;"/>

使用计算机在网络中进行通信时，每个计算机都需要一个唯一的标识符，这个标识符就是IP地址，其可以随时修改。
### IPv4
由32位二进制数组成，通常用点分十进制表示，比如192.168.0.1。\
<img src="../../Pic/Subject/Network/tcpip-ip.png" style="width:600px;padding:10px;"/>
<img src="../../Pic/Subject/Network/tcpip-ip-structure.png" style="width:400px;padding:10px;"/>

1. 一个 IP 地址可以分为两部分，网络号用于表示一个网络，主机号用于表示该网络内的一台主机。\
理论上可以接入256台主机，但有两个特殊地址不能分配\
<img src="../../Pic/Subject/Network/tcpip-ip-limit.png" style="width:500px;padding:10px;"/>
（1）网络地址：主机号比特全为 0，网络的起始地址，用于表示网络本身。\
（2）广播地址：主机号比特全为 1，是网络的结束地址，用于向网络内的所有主机进行广播。

2. IP地址分类\
<img src="../../Pic/Subject/Network/tcpip-ip-type.png" style="width:500px;padding:10px;"/>\
（1）A类地址：第一位总是为 0 ，网络号总是 1 字节，主机号总是 3 字节，一般分配给大型网络\
<img src="../../Pic/Subject/Network/tcpip-ip-type.png" style="width:500px;padding:10px;"/>\
（2）B类地址：前两位总是 10 ，网络号总是 2 字节，主机号总是 2 字节，一般分配给中型网络\
&emsp;&emsp;&emsp;地址范围：128.0.0.0 ~ 191.255.255.255\
（3）C类地址：前三位总是 110 ，网络号总是 3 字节，主机号总是 1 字节，一般分配给小型网络\
&emsp;&emsp;&emsp;地址范围：192.0.0.0 ~ 223.255.255.255\
（4）D类地址：前四位总是 1110 ，用于多播通信\
&emsp;&emsp;&emsp;地址范围：224.0.0.0 ~ 239.255.255.255\
（5）E类地址：四位总是 1111 ，保留未用\
&emsp;&emsp;&emsp;地址范围：240.0.0.0 ~ 255.255.255.255

### IPv6
由128位二进制数组成，通常用冒号分隔的16进制表示，比2001:0db8:85a3:0000:0000:8a2e:0370:7334。
### 路由器工作流程
1. 先给每一台设备加上 IP 地址，数据包除了加上数据链路层的 MAC 地址头部外，还要增加网络层的 IP 地址头部\
<img src="../../Pic/Subject/Network/tcpip-router-message.png" style="width:400px;padding:10px;"/>

2. 假设网络如下\
<img src="../../Pic/Subject/Network/tcpip-router-address.png" style="width:400px;padding:10px;"/>\
假如 A 给 C 发送数据，A 就需要先转交给路由器，然后再由路由器转交给 C。由于最底层的传输仍然需要依赖以太网，所以数据包是分成两段的\
A ~ 路由器的包如下\
<img src="../../Pic/Subject/Network/tcpip-router-address1.png" style="width:400px;padding:10px;"/>\
路由器到 C 的包如下\
<img src="../../Pic/Subject/Network/tcpip-router-address2.png" style="width:400px;padding:10px;"/>

3. 如果源 IP 与目的 IP 处于一个子网，直接将包通过交换机发出去。\
如果源 IP 与目的 IP 不处于一个子网，就交给路由器去处理。
### 子网
1. 子网是人为规定的，如 192.168.0.xxx 开头的，就算是在一个子网
2. 子网掩码：假如某设备的子网掩码定为 255.255.255.0。这表示，将源 IP 与目的 IP 分别与其进行与运算，相等则是在一个子网。
### 默认网关
当主机或需要与其他网络中的设备进行通信时，它会将数据包发送到默认网关，由默认网关负责将数据包转发到目标网络。\
默认网关的设置通常在网络设备的配置过程中完成。在大多数家庭和小型办公网络中，路由器通常被设置为默认网关。
### 路由表
路由器收到的数据包有目的 IP，需要转化成从哪个端口出去，路由器通过路由表选择路由，每个路由器中都至少保存着一张路由表。
1. 路由种类\
（1）链路层协议发现的路由（也称为接口路由或直连路由）。\
（2）由网络管理员手工配置的静态路由。\
（3）动态路由协议发现的路由。
2. 路由表种类：每台路由器中都保存着一张本地核心路由表，同时各个路由协议也维护着自己的路由表\
（1）本地核心路由表：保存协议路由和决策优选路由，这张路由表依据各种路由协议的优先级和度量值来选取路由。可以使用 display ip routing-table 命令查看\
（2）协议路由表：存放着该协议发现的路由信息。路由协议可以引入并发布其他协议生成的路由。例如，在路由器上运行OSPF（Open Shortest Path First）协议，需要使用 OSPF 协议通告直连路由、静态路由或者IS-IS（Intermediate System to Intermediate System）路由时，要将这些路由引入到 OSPF 协议的路由表中。
### ARP
全称地址解析协议（Address Resolution Protocol），它解决的是 IP 地址和 MAC 地址之间的转换问题。因为一个 IP 数据报在物理上传输的过程中，总是需要知道下一跳该去往何处。
1. ARP表：在一个局域网内，每个网络设备都自己维护一个 ARP 表，其记录了某些其他网络设备的 IP 地址-MAC 地址映射关系，该映射关系以 <IP, MAC, TTL> 三元组的形式存储。\
其中，TTL 为该映射关系的生存周期，典型值为 20 分钟，超过该时间，该条目将被丢弃。
2. 同一局域网内的 MAC 寻址\
假设 IP 地址为 137.196.7.23 的主机 A，想要给同一局域网内的 IP 地址为 137.196.7.14 主机 B，发送 IP 数据报文。\
（1）主机 A 检索自己的 ARP 表，发现 ARP 表中并无主机 B 的 IP 地址对应的映射条目。\
（2）主机 A 将构造一个 ARP 查询分组，并将其广播到所在的局域网中。\
ARP 分组是一种特殊报文，分为查询分组和响应分组两种，它们具有相同的格式，均包含了发送和接收的 IP 地址、发送和接收的 MAC 地址。\
查询分组中，接收的 MAC 地址是一个特殊值——FF-FF-FF-FF-FF-FF。\
该 MAC 地址是广播地址，也就是说，查询分组将广播给该局域网内的所有设备。\
（3）理论上每一个设备都会收到该分组，并检查查询分组的接收 IP 地址是否为自己的 IP 地址，如果是，说明查询分组已经到达了主机 B，否则丢弃。\
（4）主机 B 收到了查询分组之后，验证是对自己的问询，接着构造一个 ARP 响应分组发送给主机 A。同时，主机 B 提取查询分组中的 IP 地址和 MAC 地址信息，在自己的 ARP 表中构造一条主机 A 的 IP-MAC 映射记录。\
（5）主机 A 终将收到主机 B 的响应分组，提取出该分组中的 IP 地址和 MAC 地址后，构造映射信息，加入到自己的 ARP 表中。
3. 不同局域网内的 MAC 寻址\
假设一般场景，两台主机所在的子网由一台路由器联通。路由器作为互联设备，具有多个接口，每个接口各自维护一个 ARP 表\
（1）主机 A 查询 ARP 表，期望寻找到目标路由器的本子网接口的 MAC 地址。\
（2）主机 A 未能找到目标路由器的本子网接口的 MAC 地址，将采用 ARP 协议，问询到该 MAC 地址，由于目标接口与主机 A 在同一个子网内，该过程与同一局域网内的 MAC 寻址相同。\
（3）主机 A 获取到目标接口的 MAC 地址，先构造 IP 数据报，其中源 IP 是 A 的 IP 地址，目的 IP 地址是 B 的 IP 地址，再构造链路层帧，其中源 MAC 地址是 A 的 MAC 地址，目的 MAC 地址是本子网内与路由器连接的接口的 MAC 地址。主机 A 将把这个链路层帧，以单播的方式，发送给目标接口。\
（4）目标接口接收到了主机 A 发过来的链路层帧，解析，根据目的 IP 地址，查询转发表，将该 IP 数据报转发到与主机 B 所在子网相连的接口上。到此，该帧已经从主机 A 所在的子网，转移到了主机 B 所在的子网了。\
（5）路由器接口查询 ARP 表，期望寻找到主机 B 的 MAC 地址。\
（6）路由器接口如未能找到主机 B 的 MAC 地址，将采用 ARP 协议，广播问询，单播响应，获取到主机 B 的 MAC 地址。\
（7）路由器接口将对 IP 数据报重新封装成链路层帧，目标 MAC 地址为主机 B 的 MAC 地址，单播发送，直到目的地。

## 传输层
1. 为端到端连接提供传输服务；
2. 这种传输服务分为可靠和不可靠的，其中TCP是典型的可靠传输，而UDP则是不可靠传输；
3. 为端到端连接提供流量控制、差错控制、QoS(Quality of Service)服务质量等管理服务。
4. 传输层主要有两个性质不同的协议：TCP传输控制协议和UDP用户数据报协议。\
（1）TCP协议是一个面向连接的、可靠的传输协议，它提供一种可靠的字节流，能保证数据完整、无损并且按顺序到达。TCP尽量连续不断地测试网络的负载并且控制发送数据的速度以避免网络过载。另外，TCP试图将数据按照规定的顺序发送。\
（2）UDP协议是一个无连接的数据报协议，是一个“尽力传递”和“不可靠”协议，不会对数据包是否已经到达目的地进行检查，并且不保证数据包按顺序到达。

## 应用层
包括所有和应用程序协同工作，并利用基础网络交换应用程序的业务数据的协议。一些特定的程序被认为运行在这个层上，该层协议所提供的服务能直接支持用户应用。包括HTTP（万维网服务）、FTP（文件传输）、SMTP（电子邮件）、SSH（安全远程登陆）、DNS（域名解析）以及许多其他协议。

