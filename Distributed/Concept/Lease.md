### 问题背景
在一个分布式系统中，有一个中心服务器节点，存储、维护着系统的元数据。其他节点通过访问中心服务器节点读取、修改其上的元数据。由于系统中各种操作都依赖于元数据，中心服务器节点性能是系统的瓶颈。\
为此，设计一种元数据 cache，在各个节点上 cache 元数据信息，从而减少对中心服务器节点的访问，提高性能。另一方面，系统的正确运行严格依赖于元数据的正确，这就要求各个节点上 cache 的数据始终与中心服务器上的数据一致。最后，设计的 cache 系统要能最大可能的处理节点宕机、网络中断等异常，提高系统的可用性。
### 基本原理
1. 中心服务器在向各节点发送数据时同时颁发一个 lease，其具有一个有效期，通常是一个明确的时间点，例如 12:00:10，一旦超过则 lease 过期失效。
2. lease 的有效期与节点收到 lease 的时间无关，可能收到时该 lease 就已经过期失效。
3. 这里假设中心服务器与各节点的时钟是同步的，lease 的含义为：在有效期内，中心服务器保证不会修改对应数据的值。因此，节点收到数据和 lease 后，将数据加入本地 cache，一旦对应的 lease 超时，节点将对应的 cache 数据删除。中心服务器在修改数据时，首先阻塞所有新的读请求，并等待之前为该数据发出的所有 lease 超时过期，然后修改数据。
### 客户端节点读取元数据
判断元数据是否已经处于本地 cache 且 lease 处于有效期内
1. 是：直接返回 cache 中的元数据
2. 否：向中心服务器节点请求读取元数据信息\
（1）服务器收到读取请求后，返回元数据及一个对应的 lease\
（2）客户端是否成功收到服务器返回的数据\
&emsp;&emsp;&emsp;失败或超时：退出流程，读取失败，可重试\
&emsp;&emsp;&emsp;成功：将元数据与该元数据的 lease 记录到内存中，返回元数据
### 客户端节点修改取元数据
1. 节点向服务器发起修改元数据请求。
2. 服务器收到修改请求后，阻塞所有新的读数据请求，即接收读请求，但不返回数据。
3. 服务器等待所有与该元数据相关的 lease 超时。
4. 服务器修改元数据并向客户端节点返回修改成功。
### 优化
1. 上述机制可以保证节点的 cache 与中心服务器始终一致。服务器一旦发出数据及 lease，无论客户端是否收到，也无论是否宕机和网络是否正常，服务器只要等待 lease 超时，就可以保证对应的客户端节点不会再继续 cache 数据，从而可以放心的修改数据而不会破坏 cache 的一致性。
2. 上述流程有一些性能和可用性上的问题，服务器在修改元数据时首先要阻塞所有新的读请求。这是为了防止发出新的 lease 从而引起不断有新客户端节点持有 lease 并缓存着数据，形成“活锁”。
3. 优化：服务器在进入修改数据流程后，一旦收到读请求则只返回数据但不颁发 lease。修改流程执行的过程中，客户端可以读到元数据，只是不能缓存元数据。
4. 进一步的优化是，当进入修改流程，服务器颁发的 lease 有效期限选择为已发出的的最大有效期限，客户端可以继续在服务器进入修改流程后缓存元数据。
5. Cache 机制与多副本机制的相似之处都是将一份数据保存在多个节点上。对于 cache 的数据，可以随时删除丢弃，并命中 cache 的后果仅仅是需要访问数据源读取数据；然而副本是不能随意丢弃的，每失去一个副本，服务质量都在下降，一旦副本数下降到一定程度，则服务将不可用。
### 分析
1. 能很好容错网络异常。即使网络单向通信，也不影响 lease 的颁发。由于 lease 的有效期是一个确定的时间点，lease 的语义与发送 lease 的具体时间无关，所以颁发者可以重复发送同一个 lease。一旦 lease 被成功接受，后续即使网络完全中断 lease 机制也不受影响。
2. 能很好容错节点宕机。如果颁发者宕机，通常无法改变之前的承诺，不会影响 lease 的正确性。在颁发者机恢复后，如果恢复了之前的 lease 信息，可以继续遵守 lease 的承诺。如果无法恢复，则只需等待一个最大超时时间。
3. Lease 机制依赖于有效期，这就要求颁发者和接收者的时钟是同步的。一方面，如果颁发者的时钟比接收者慢，则当接收者认为 lease 已经过期的时候，颁发者依旧认为 lease 有效。接收者可以在 lease 到期前申请新的 lease 解决这个问题。另一方面，如果颁发者的时钟比接收者快，则当颁发者认为 lease 已经过期的时候，接收者依旧认为 lease 有效，颁发者可能将 lease 颁发给其他节点，造成承诺失效，影响系统的正确性。实践中通常将颁发者的有效期设置得比接收者的略大，只需大过时钟误差就可以避免对 lease 的有效性的影响。
4. 工程中，常选择的lease 时长是 10 秒级别，这是一个经过验证的经验值。
### 确定节点状态
分布式协议依赖于对节点状态认知的全局一致性，即一旦节点 Q 认为某个节点 A 异常，则节点 A 也必须认为自己异常，从而节点 A 停止作为 primary，避免“双主”问题的出现。
1. 解决这种问题有两种思路\
（1）设计的分布式协议可以容忍“双主”错误，即不依赖于对节点状态的全局一致性认识，或者全局一致性状态是全体协商后的结果。\
（2）利用 lease 机制。第一种思路即改用去中心化设计，下面着重讨论利用 lease 机制确定节点状态。
2. 由中心节点向其他节点发送 lease，若某个节点持有有效的 lease，则认为该节点正常可以提供服务。如节点 A、B 周期性发送 heart beat 报告自身状态，节点 Q 收到 heart beat 后发送一个 lease，表示确认了节点 A、B 的状态。节点 Q 可以给 primary 节点一个特殊的 lease，表示其可以作为 primary 工作。一旦节点 Q 希望切换新的 primary，则只需等前一个 primary 的lease 过期，则就可以安全的颁发新的 lease，而不会出现“双主”问题。
3. 在实际系统中，若用一个中心节点发送 lease，一旦该中心节点宕机或网络异常，则所有的节点没有 lease，从而造成系统高度不可用。为此，实际系统总是使用多个中心节点互为副本，成为一个小的集群，该小集群具有高可用性，对外提供颁发 lease 的功能。chubby 和zookeeper 都是基于这样的设计。