## CAP
在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性）这三个基本需求，最多只能同时满足其中的2个。
### 不可兼得例子
1. 分区：分布式系统中，不同的节点分布在不同的子网络中，若这些子节点之间出现了网络不通的状态，他们的内部子网络是正常的。整个系统的环境被切分成了若干个孤立的区域，这就是分区。
2. 假设满足分区容错，有两个分区 N1 和 N2，N1 和 N2 分别有不同的分区存储 D1 和 D2，以及不同的服务 S1 和 S2。\
<img src="../../Pic/Distributed/Concept/intro-cap.png"  style="width:400px;padding:10px;"/>

3. 场景：用户访问了 N1，修改了 D1 的数据。用户再次访问，请求落在了 N2 。此时 D1 和 D2 的数据不一致。
4. 保证一致性：此时 D1 和 D2 数据不一致，要保证一致性就不能返回不一致的数据，可用性无法保证。
5. 保证可用性：立即响应，可用性得到了保证，但是此时响应的数据和 D1 不一致，一致性无法保证。
6. 分区容错的前提下，一致性和可用性是矛盾的。
### 原则权衡
1. CA without P
如果不要求 P（不允许分区），则 C（强一致性）和 A（可用性）是可以保证的。但是对于分布式系统，分区是客观存在的，其实分布式系统理论上是不可选 CA 的。
2. CP without A
如果不要求 A（可用），相当于每个请求都需要在 Server 之间强一致，而 P（分区）会导致同步时间无限延长，如此 CP 也是可以保证的。很多传统的数据库分布式事务都属于这种模式。
3. AP wihtout C
要高可用并允许分区，则需放弃一致性。一旦分区发生，节点之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。现在众多的 NoSQL 都属于此类。
### 实际应用
1. ZooKeeper 保证的是 CP。任何时刻对 ZooKeeper 的读请求都能得到一致性的结果，但不保证每次请求的可用性，比如在 Leader 选举过程中或者半数以上的机器不可用的时候服务就是不可用的。
2. Eureka 保证的则是 AP。在设计的时候就是优先保证 A。不存在什么 Leader 节点，每个节点都是一样的、平等的。保证即使大部分节点挂掉也不会影响正常提供服务，只要有一个节点是可用的就行了。只不过这个节点上的数据可能并不是最新的。
3. Nacos 不仅支持 CP 也支持 AP。
### 协议分析
1. Lease: 牺牲了部分异常情况下的 A，从而获得了完全的 C 与很好的 P。
2. Quorum: 在 CAP 三大因素中都各做了折中，有一定的 C，有较好的 A 和 P，是一种较为平衡的分布式协议。
3. 两阶段提交协议: 完全的C，很糟糕的 A，很糟糕的 P。
4. Paxos：同样是强一致性协议，Paxos 在 CAP 三方面较之两阶段提交协议要优秀得多。具有完全的 C，较好的 A 和 P。Paxos 的 A 与 P 的属性与 Quorum 类似，因为 Paxos 的协议本身就具有 Quorum 机制。