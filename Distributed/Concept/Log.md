日志技术是宕机恢复的主要技术之一，最初使用在数据库系统中。在分布式系统的实践中，广泛使用了日志技术做宕机恢复，甚至如 BigTable 等系统将日志保存到一个分布式系统中进一步增强了系统容错能力。
## Redo Log（重做日志）
设计一个高速的单机查询系统，将数据全部存放在内存中，每次更新操作更新一小部分数据（例如 key-value 中的某一个key）。问题为利用日志技术实现该内存查询系统的宕机恢复。与数据库的事务不同的是，这个问题模型中的每个成功的更新操作都会生效。
### 更新
1. 将更新操作的结果（例如Set K1=1，则记录K1=1）以追加写（append）的方式写入磁盘的日志文件
2. 按更新操作修改内存中的数据
3. 返回更新成功
4. 由于是顺序追加写日志文件，在磁盘等对顺序写有力的存储设备上效率较高。
### 宕机恢复
1. 从头读取日志文件中的每次更新操作的结果，用这些结果修改内存中的数据。
2. 只有写入日志文件的更新结果才能在宕机后恢复。这也是为什么在 Redo Log 流程中需要先更新日志文件再更新内存中的数据的原因。
## Check point
即将内存中的数据以某种易于重新加载的数据组织方式完整的 dump 到磁盘，从而减少宕机恢复时需要回放的日志数据。
### 更新
1. 向日志文件中记录 “Begin Check Point”
2. 将内存中的数据以某种易于重新加载的数据组织方式 dump 到磁盘上
3. 向日志文件中记录 “End Check Point”
4. 在check point 流程中，数据可以继续更新，新更新的数据可选择是否 dump 到磁盘，具体取决于实现。例如，check point 开始时 k1 = v1，check point 过程中更新为 k1 = v2，那么 dump 到磁盘上的 k1 的值可以是 v1 也可以是 v2。
### 宕机恢复
1. 将 dump 到磁盘的数据加载到内存。
2. 从后向前扫描日志文件，寻找最后一个 “End Check Point” 日志。
3. 从最后一个 “End Check Point” 日志向前找到最近的一个 “Begin Check Point” 日志，并回放该日志之后的所有更新操作日志。
## No Undo/No Redo log
若数据维护在磁盘中，某批更新由若干个更新操作组成，这些更新操作需要原子生效，即要么同时生效，要么都不生效。\
<img src="../../Pic/Distributed/Concept/log-01.jpg"  style="width:400px;padding:10px;"/>

0/1 目录技术中有两个目录结构，称为目录 0 和 1。另有一个结构称为主记录，记录当前正在使用的目录称为活动目录。目录0 或 1 中记录了各个数据的在日志文件中的位置。0/1 目录的数据更新过程始终在非活动目录上进行，只是在数据生效前，将主记录中的0、1 值反转，从而切换主记录。
### 数据更新
1. 将活动目录完整拷贝到非活动目录。
2. 对于每个更新操作，新建一个日志项纪录操作后的值，并在非活动目录中将相应数据的位置修改为新建的日志项的位置。
3. 原子性修改主记录：反转主记录中的值，使得非活动目录生效。
