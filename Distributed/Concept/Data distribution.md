## 概述
单机系统与分布式系统的最大的区别在于问题的规模，将一个单机问题使用分布式解决，首先要解决的就是如何将问题拆解为可以使用多机分布式解决，使得分布式系统中的每台机器负责原问题的一个子集。\
由于无论是计算还是存储，其问题输入对象都是数据，所以如何拆解分布式系统的输入数据成为分布式系统的基本问题。
## 哈希
1. 可扩展性不高：一旦集群规模需要扩展，则几乎所有的数据需要被迁移并重新分布。\
工程中扩展哈希分布数据的系统时，往往使集群规模成倍扩展，按照数据重新计算哈希，这样原本一台机器上的数据只需迁移一半到另一台对应的机器上即可完成扩展。
2. 数据倾斜（data skew）：可能数据分布不均。
3. 针对可扩展性不高问题，一种思路是不再将哈希值与机器做除法取模映射，而是将对应关系作为元数据由专门的元数据服务器管理。同时，哈希值取模个数往往大于机器个数，这样同一台机器上需要负责多个哈希取模的余数。但需要以较复杂的机制维护大量的元数据。
## 按数据范围分布
1. 将数据按特征值的值域范围划分为不同的区间，使得集群中每台（组）服务器处理不同区间的数据。
2. 工程中，为了数据迁移等负载均衡操作的方便，往往动态划分区间使得每个区间中服务的数据量尽量一样多。当某个区间的数据量较大时，将其拆分为两个区间，使得每个区间的数据量尽量维持在某一阈值之下。
3. 一般需要专门的服务器在内存中维护数据分布信息。对于大规模的集群，由于元信息规模庞大，需要使用多台机器作为元信息服务器。
## 按数据量分布
1. 与具体的数据特征无关，而是将数据视为一个顺序增长的文件，并将这个文件按照某一较为固定的大小划分为若干数据块（chunk），分布到不同的服务器上。
2. 按数据量分布数据也需要记录数据块的具体分布情况，并将该分布信息作为元数据使用元数据服务器管理。
3. 当集群需要重新负载均衡时，只需通过迁移数据块即可完成。集群扩容也没有太大的限制，只需将部分数据库迁移到新加入的机器上即可以完成扩容。
## 一致性哈希
1. 基本方式是使用一个哈希函数计算数据或数据特征的哈希值，令该哈希函数的输出值域为一个封闭的环，将节点随机分布到这个环上，每个节点负责处理从自己开始顺时针至下一个节点的全部哈希值域上的数据。\
<img src="../../Pic/Distributed/Concept/data-hash.jpg"  style="width:400px;padding:10px;"/>

2. 需要将节点在一致性哈希环上的位置作为元信息加以管理，比直接使用哈希分布数据的方式要复杂。但节点的位置信息只与集群中的机器规模相关，其元信息量通常比按数据范围分布和按数据量分布要小很多。
3. 另一种常见改进算法是引入虚节点，系统初始时就创建许多虚节点，个数一般远大于未来集群中机器个数，将其均匀分布到一致性哈希值域环上。为每个节点分配若干虚节点。操作数据时，首先通过数据的哈希值在环上找到对应的虚节点，进而查找元数据找到对应的真实节点。
4. 使用虚节点改进有多个优点。首先，一旦某个节点不可用，该节点将使得多个虚节点不可用，从而使得多个相邻的真实节点负载失效节点的压力。同理，一旦加入一个新节点，可以分配多个虚节点，从而使得新节点可以负载多个原有节点的压力，从全局看，较容易实现扩容时的负载均衡。
## 副本与数据分布
1. 分布式系统容错、提高可用性的基本手段就是使用副本。一种基本策略是以机器为单位，若干机器互为副本，副本机器之间的数据相同。这种策略适用于上述各种数据分布方式。优点是非常简单，缺点是恢复数据效率不高、可扩展性不高。
2. 更合适的做法是将数据拆为较合理的数据段，以数据段为单位作为副本。实践中，常常使得每个数据段的大小尽量相等且控制在一定的大小以内。数据段的选择与数据分布方式直接相关。对于哈希分数据的方式，每个哈希分桶后的余数可以作为一个数据段，为了控制数据段的大小，常常使得分桶个数大于集群规模。
3. 副本分布与机器无关，数据丢失后的恢复效率将非常高；利于集群容错，如果机器宕机，宕机机器上的副本分散于整个集群；利于集群扩展。理论上设集群规模为 N 台机器，加入一台新机器，只需从各机器上迁移1/N – 1/N+1 比例的数据段到新机器即实现了新的负载均衡。
4. 工程中，完全按照数据段建立副本会使管理元数据开销增大，一种折中的做法是将某些数据段组成一个数据段分组，按数据段分组为粒度进行副本管理。这样可以将副本粒度控制在一个较为合适的范围内。
## 本地化计算
在分布式系统中计算节点和存储节点可以在同一台物理机器上，也可以位于不同的物理机器。如果计位于不同的物理机器，则计算的数据需要通过网络传输，此种方式的开销很大，甚至网络带宽可能成为系统的总体瓶颈。另一种思路是，将计算尽量调度到与存储节点在同一台物理机器上的计算节点上进行，这称之为本地化计算。
## 分布方式选择
数据倾斜问题，在按哈希分数据的基础上引入按数据量分布数据的方式，解决该数据倾斜问题。按用户id 的哈希值分数据，当某个用户id 的数据量特别大时，该用户的数据始终落在某一台机器上。此时，引入按数据量分布数据的方式，统计用户的数据量，并按某一阈值将用户的数据切为多个均匀的数据段，将这些数据段分布到集群中去。由于大部分用户的数据量不会超过阈值，所以元数据中仅仅保存超过阈值的用户的数据段分布信息，从而可以控制元数据的规模。这种哈希分布数据方式与按数据量分布数据方式组合使用的方案，在某真实系统中使用，取得了较好的效果。