经典的强一致性中心化副本控制协议。虽然在工程中该协议有较多的问题，但研究该协议能很好的理解分布式系统的几个典型问题。
## 流程
在该协议中，参与的节点分为两类：一个中心化协调者节点（coordinator）和 N 个参与者节点（participant）。\
1. 第一阶段，协调者询问所有的参与者是否可以提交事务（请参与者投票），所有参与者向协调者投票。
2. 第二阶段，协调者根据投票结果做出事务是否可以全局提交的决定，并通知所有的参与者执行该决定。
3. 在两阶段提交流程中，参与者不能改变自己的投票结果。两阶段提交协议的可以全局提交的前提是所有的参与者都同意提交事务。
### 协调者流程
1. 写本地日志 “begin_commit”，并进入 WAIT 状态；
2. 向所有参与者发送 “prepare”；
3. 等待并接收参与者发送的对 “prepare” 的响应；\
（1）3.1 若收到任何一个参与者发送的 “vote-abort” ；\
3.1.1 写本地 “global-abort” 日志，进入 ABORT；\
3.1.2 向所有的参与者发送 “global-abort”；\
3.1.3 进入 ABORT 状态；\
（2）3.2 若收到所有参与者发送的 “vote-commit”；\
3.2.1 写本地 “global-commit” 日志，进入 COMMIT 状态；\
3.1.2 向所有的参与者发送 “global-commit”；
4. 等待并接收参与者发送的对 “global-abort” 或 “global-commit” 的确认响应消息，一旦收到所有参与者的确认消息，写本地 “end_transaction” 日志流程结束。
### 参与者流程
1. 写本地日志 “init” 记录，进入 INIT 状态
2. 等待并接受协调者发送的 “prepare”
3. 若参与者可以提交本次事务 \
（1） 写本地日志 “ready”，进入 READY 状态 \
（2） 向协调者发送 “vote-commit” \
（3） 等待协调者的消息\
3.1 若收到协调者的 “global-abort”\
3.1.1 写本地日志 “abort”，进入 ABORT 状态\
3.1.2 向协调者发送对 “global-abort” 的确认消息\
3.2 若收到协调者的 “global-commit”\
3.1.1 写本地日志 “commit”，进入 COMMIT 状态\
3.1.2 向协调者发送对 “global-commit” 的确认消息
4. 若参与者无法提交本次事务\
（1） 写本地日志 “abort”，进入 ABORT 状态 \
（2） 向协调者发送 “vote-abort”\
（3） 流程对该参与者结束\
（4） 若后续收到协调者的 “global-abort” 可以响应
5. 即使流程结束，任何时候收到 “global-abort” 或 “global-commit” 都要发送一个对应的确认消息。
## 宕机恢复
### 协调者 
1. 宕机恢复后，查找日志得到宕机前的状态。
2. 如果最后是 “begin_commit”，说明宕机前处于 WAIT 状态，可能已经发送过 “prepare”，但一定没发送过 “global-commit” 或 “global-abort”。
3. 重新发送 “prepare” 继续两阶段提交流程，即使参与者已经发送过响应消息，也不会影响协议的一致性。
4. 如果最后是 “global-commit” 或 “global-abort”，说明宕机前处于 COMMIT 或 ABORT 状态。
5. 重新向所有的参与者发送 “global-commit” 或 “global-abort” 就可以继续两阶段提交流程。
### 参与者
1. 宕机恢复后，查找日志得到宕机前的状态。
2. 如果最后是 “init”，说明处于 INIT 状态，还没有对本次事务做出投票选择，可以继续流程等待协调者发送的 “prepare”。
3. 如果最后是 “ready”，说明处于 REDAY 状态，已经就本次事务做出了投票选择，但宕机前参与者是否已经向协调者发送 “vote-commit” 并不可知。可以重发“vote-commit”，并继续协议流程。
4. 如果最后是 “commit” 或 “abort”，说明已经收到过 “global-commit” 或者 “global-abort”。至于是否发送过 “global-commit” 或 “global-abort” 的确认消息则未知。
5. 即使没有发送过确认消息，由于协调者会不断重发 “global-commit” 或 “global-abort”，只需在收到这些消息时发送确认消息既可，不影响协议的全局一致性。
## 分析
在工程实践中真正使用的较少，主要原因有以下几点：
1. 容错能力较差。在某些情况下存在流程无法执行下去的情况，也无法判断流程状态。
2. 性能较差。一次成功的两阶段提交协议流程中，协调者与每个参与者之间至少需要 2 轮交互 4 个消息 “prepare”、“vote-commit”、“global-commit”、“确认global-commit”。过多的交互次数会降低性能。另一方面，协调者需要等待所有的参与者的投票结果，一旦存在较慢的参与者，会影响全局流程执行速度。