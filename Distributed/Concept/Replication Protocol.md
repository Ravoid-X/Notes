## 概论
副本控制协议指按特定的协议流程控制副本数据的读写行为，使得副本满足一定的可用性和一致性要求的分布式协议。\
副本控制协议要具有一定的对抗异常状态的容错能力，从而使得系统具有一定的可用性，同时要能提供一定一致性级别。\
为此，实际中的副本控制协议总是在可用性、一致性与性能等各要素之间按照具体需求折中。\
副本控制协议可以分为两大类：中心化 (centralized) 副本控制协议 和 去中心化 (decentralized) 副本控制协议。
## 中心化副本控制协议
基本思路是由一个中心节点协调副本数据的更新、维护副本之间的一致性。
1. 优点：协议相对简单，所有副本相关控制交由中心节点完成。使得分布式并发控制问题，简化为单机并发控制问题。
2. 并发控制：多个节点同时需要修改副本数据时，需要解决“写写”、“读写”等并发冲突。单机系统上常用加锁等方式进行并发控制。对于分布式并发控制，加锁也是一个常用的方法，但如果没有中心节点统一进行锁管理，就需要完全分布式化的锁系统，会使得协议非常复杂。
3. 缺点：系统的可用性依赖于中心化节点，当中心节点异常或与中心节点通信中断时，系统将失去某些服务（通常至少失去更新服务）。
### primary-secondary 协议
此协议中，副本被分为两大类，有且仅有一个副本作为 primary 副本，除 primary 以外的副本都作为 secondary 副本。维护 primary 副本节点作为中心节点，中心节点负责维护数据的更新、并发控制、协调副本的一致性。\
Primary-secondary 类型的协议一般要解决四大类问题：数据更新流程、数据读取方式、Primary 副本的确定和切换、数据同步（reconcile）
### 数据更新基本流程
1. 数据更新都由 primary 节点协调完成。
2. 外部节点将更新操作发给 primary 节点
3. primary 节点进行并发控制即确定并发更新操作的先后顺序
4. primary 节点将更新操作发送给 secondary 节点
5. primary 根据 secondary 节点的完成情况决定更新是否成功并将结果返回外部节点
6. 工程实践中，如果 primary 节点直接同时给其他 N 个副本发送数据，则每个 secondary 的更新吞吐受限于 primary 总的出口网络带宽。面对此问题，有些系统（例如GFS）使用接力的方式同步数据，即 primary 将更新发送给第一个 secondary 副本，第一个 secondary 副本发送给第二 secondary 副本，依次类推。
### 数据读取方式
1. 数据读取方式与一致性高度相关。如只需最终一致性，读取任何副本都可满足。如需会话一致性，则可为副本设置版本号，每次更新后递增版本号，用户读取时验证版本号，从而保证用户读到的数据在会话范围内单调递增。使用 primary-secondary 比较困难的是实现强一致性。
2. 由于数据更新流程由 primary 控制，其上的数据一定是最新的，所以只读 primary 副本的数据，可以实现强一致性。实践中，如果副本不与机器绑定，而是按照数据段为单位维护副本，仅有primary 副本提供读服务在很多场景下并不会造出机器资源浪费。
3. 将副本分散到集群中，假设 primary 也是随机的确定的，那么每台机器上都有一些数据的primary 副本，也有另一些数据段的 secondary 副本。从而某台服务器实际都提供读写服务。
4. 由 primary 控制 secondary 的可用性。当 primary 更新某个 secondary 副本不成功时，将其标记为不可用，使用户不再读取。不可用的 secondary 副本可以继续尝试与 primary 同步数据，当完成数据同步后，标记为可用。这种方式使得所有的可用副本都是可读的，且在一个确定的时间内，某 secondary 副本要么更新到与 primary 一致的最新状态，要么被标记为不可用，符合较高的一致性要求。这种方式依赖于一个中心元数据管理系统，用于记录副本可用性。某种意义上，其通过降低系统的可用性来提高系统的一致性。
### primary 副本的确定与切换
1. 一个核心的问题是如何确定 primary 副本，尤其是在原 primary 副本所在机器出现宕机等异常时，需要有某种机制使得某个 secondary 副本成为新的 primary 副本。
2. 通常的，在 primary-secondary 类型的分布式系统中，哪个副本是 primary 属于元信息。执行更新操作时，首先查询元数据服务器获取副本的 primary 信息，从而进一步执行数据更新流程。
3. 由于分布式系统中可靠的发现节点异常需要探测时间，通常是 10 秒级别。意味着一旦 primary 异常，最多需要 10 秒级别的发现时间，系统才能开始 primary 的切换，在这 10 秒时间内，由于没有 primary，系统不能提供更新服务，如果系统只能读 primary 副本，则这段时间内甚至不能提供读服务。可见 primary-backup 类副本协议的最大缺点就是 primary 切换会带来一定的停服务时间。
### 数据同步
不一致的secondary 副本需要与primary 进行同步（reconcile）。
1. 通常不一致的形式有三种\
（1）由于网络分化等异常，secondary 上的数据落后于 primary。\
（2）在某些协议下，secondary 上的数据有可能是脏数据，需要被丢弃。脏数据是指 primary 副本没有进行某一更新操作，而 secondary 副本上反而进行的多余的修改操作，从而造成secondary 副本数据错误。\
（3）secondary 是一个新增加的副本，完全没有数据，需要从其他副本上拷贝数据。
2. 解决方法\
（1）常见的同步方式是回放 primary 上的操作日志（通常是 redo 日志），从而追上primary 的更新进度。\
（2）较好的做法是设计的分布式协议不产生脏数据。如果协议一定有产生脏数据的可能，也应该使得其概率非常低，一旦产生脏数据可以简单的直接丢弃副本，这样相当于副本没有数据。另外，也可以设计一些基于 undo 日志的方式从而可以删除脏数据。\
（3）常见的做法是直接拷贝 primary 副本的数据，往往比回放日志追更新进度的方法快很多。但拷贝数据时 primary 副本需要能够继续提供更新服务，这就要求 primary 副本支持快照功能。即对某一刻的副本数据形成快照，然后拷贝快照，拷贝完成后使用回放日志的方式追快照形成后的更新操作。

## 去中心化副本控制协议
1. 去中心化副本控制协议中所有的节点都是完全对等的，节点之间通过平等协商达到一致，因此没有因为中心化节点异常而带来的停服务等问题。
2. 最大的缺点是协议过程通常比较复杂，尤其当需要实现强一致性时。由于流程复杂，效率一般也较中心化协议低。