## 概述
1. 全称地址解析协议（Address Resolution Protocol），解决的是 IP 地址和 MAC 地址之间的转换问题。
2. 因为一个 IP 数据报在物理上传输的过程中，总是需要知道下一跳该去往何处。
### ARP表
1. 在一个局域网内，每个网络设备都自己维护一个 ARP 表，其记录了某些其他网络设备的 IP 地址-MAC 地址映射关系。
2. 该映射关系以 <IP, MAC, TTL> 三元组的形式存储。
3. 其中，TTL 为该映射关系的生存周期，典型值为 20 分钟，超过该时间，该条目将被丢弃。
## 同一局域网内的 MAC 寻址
假设 IP 地址为 137.196.7.23 的主机 A，想要给同一局域网内的 IP 地址为 137.196.7.14 主机 B，发送 IP 数据报文。
### 检索
主机 A 检索自己的 ARP 表，发现 ARP 表中并无主机 B 的 IP 地址对应的映射条目。
### 广播
主机 A 将构造一个 ARP 查询分组，并将其广播到所在的局域网中。
### ARP 分组
1. 一种特殊报文，分为查询分组和响应分组两种，它们具有相同的格式，均包含了发送和接收的 IP 地址、发送和接收的 MAC 地址。
2. 查询分组中，接收的 MAC 地址是一个特殊值——FF-FF-FF-FF-FF-FF。
3. 该 MAC 地址是广播地址，也就是说，查询分组将广播给该局域网内的所有设备。\
### 检查
1. 理论上每一个设备都会收到该分组，并检查查询分组的接收 IP 地址是否为自己的 IP 地址。
2. 如果是，说明查询分组已经到达了主机 B，否则丢弃。
### 响应与构建
1. 主机 B 收到了查询分组之后，验证是对自己的问询，接着构造一个 ARP 响应分组发送给主机 A。
2. 同时，主机 B 提取查询分组中的 IP 地址和 MAC 地址信息，在自己的 ARP 表中构造一条主机 A 的 IP-MAC 映射记录。
3. 主机 A 终将收到主机 B 的响应分组，提取出该分组中的 IP 地址和 MAC 地址后，构造映射信息，加入到自己的 ARP 表中。

## 不同局域网内的 MAC 寻址
假设一般场景，两台主机所在的子网由一台路由器联通。路由器作为互联设备，具有多个接口，每个接口各自维护一个 ARP 表
### 检索
主机 A 检索 ARP 表，期望寻找到目标路由器的本子网接口的 MAC 地址。
### 同局域网 MAC 寻址操作
主机 A 未能找到目标路由器的本子网接口的 MAC 地址，将采用 ARP 协议，问询到该 MAC 地址，由于目标接口与主机 A 在同一个子网内，该过程与同一局域网内的 MAC 寻址相同。
### 发送链路层帧
1. 主机 A 获取到目标接口的 MAC 地址
2. 先构造 IP 数据报，其中源 IP 是 A 的 IP 地址，目的 IP 地址是 B 的 IP 地址。
3. 再构造链路层帧，其中源 MAC 地址是 A 的 MAC 地址，目的 MAC 地址是本子网内与路由器连接的接口的 MAC 地址。
4. 主机 A 将把这个链路层帧，以单播的方式，发送给目标接口。
### 转发
1. 目标接口接收到了主机 A 发过来的链路层帧，解析，根据目的 IP 地址，查询转发表，将该 IP 数据报转发到与主机 B 所在子网相连的接口上。
2. 到此，该帧已经从主机 A 所在的子网，转移到了主机 B 所在的子网了。
### 查询
1. 路由器接口查询 ARP 表，期望寻找到主机 B 的 MAC 地址。
2. 路由器接口如未能找到主机 B 的 MAC 地址，将采用 ARP 协议，广播问询，单播响应，获取到主机 B 的 MAC 地址。
### 响应
路由器接口将对 IP 数据报重新封装成链路层帧，目标 MAC 地址为主机 B 的 MAC 地址，单播发送，直到目的地。